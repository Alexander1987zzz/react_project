{"version":3,"file":"react-form-with-constraints-tools.development.js","sources":["../src/DisplayFields.tsx"],"sourcesContent":["import * as React from 'react';\nimport * as PropTypes from 'prop-types';\nimport {\n  Async as _Async,\n  Field,\n  FieldEvent,\n  FieldFeedback as _FieldFeedback,\n  FieldFeedbacks as _FieldFeedbacks,\n  FieldFeedbackType,\n  FormWithConstraints,\n  FormWithConstraintsChildContext,\n  isHTMLInput\n} from 'react-form-with-constraints';\n\n// Before:\n// [\n//   {\n//     \"element\": \"<input id=\\\"username\\\" name=\\\"username\\\" required=\\\"\\\" minlength=\\\"3\\\" class=\\\"form-control is-pending-sm is-invalid\\\" value=\\\"\\\">\",\n//     \"name\": \"username\",\n//     \"validations\": [\n//       { \"key\": \"0.0\", \"type\": \"error\", \"show\": false },\n//       { \"key\": \"0.1\", \"type\": \"error\", \"show\": true },\n//       { \"key\": \"0.2\", \"type\": \"whenValid\" }\n//     ]\n//   }\n// ]\n//\n// After:\n// [\n//   {\n//     element: <input id=\"username\" name=\"username\" required=\"\" minlength=\"3\" class=\"form-control is-pending-sm is-invalid\" value=\"\">,\n//     name: \"username\",\n//     validations: [\n//       { key: \"0.0\", type: \"error\", show: false },\n//       { key: \"0.1\", type: \"error\", show: true },\n//       { key: \"0.2\", type: \"whenValid\", show: undefined }\n//     ]\n//   }\n// ]\n// eslint-disable-next-line @typescript-eslint/ban-types\nfunction beautifulStringify(obj: {}, space?: string | number) {\n  // Keep undefined\n  // [Preserving undefined that JSON.stringify otherwise removes](https://stackoverflow.com/q/26540706)\n  let str = JSON.stringify(\n    obj,\n    (_key, value) => (value === undefined ? '__undefined__' : value),\n    space\n  );\n  str = str.replace(/\"__undefined__\"/g, 'undefined');\n\n  // Remove quotes from properties\n  // Before: \"name\":\n  // After: name:\n  // [JSON.stringify without quotes on properties?](https://stackoverflow.com/q/11233498)\n  str = str.replace(/\"([^\"]+)\":/g, '$1:');\n\n  // Before: element: \"<input id=\\\"username\\\" name=\\\"username\\\" required=\\\"\\\">\",\n  // After: element: <input id=\\\"username\\\" name=\\\"username\\\" required=\\\"\\\">,\n  // eslint-disable-next-line unicorn/better-regex\n  str = str.replace(/: \"(.*[\\\\\"].*)\",/g, ': $1,');\n\n  // Before: <input id=\\\"username\\\" name=\\\"username\\\" required=\\\"\\\">\n  // After: <input id=\"username\" name=\"username\" required=\"\">\n  str = str.replace(/\\\\\"/g, '\"');\n\n  return str;\n}\n\n// Cannot display field.element directly, will throw \"Converting circular structure to JSON\" when calling JSON.stringify()\nfunction normalizeFieldElementProperty(fields: Field[]) {\n  return fields.map(field => {\n    const { element, ...otherProps } = field;\n    return element\n      ? {\n          element: isHTMLInput(element) ? element.outerHTML : element.props,\n          ...otherProps\n        }\n      : field;\n  });\n}\n\nexport class DisplayFields extends React.Component {\n  static contextTypes: React.ValidationMap<FormWithConstraintsChildContext> = {\n    form: PropTypes.instanceOf(FormWithConstraints).isRequired\n  };\n  context!: FormWithConstraintsChildContext;\n\n  /* eslint-disable react/destructuring-assignment */\n\n  componentDidMount() {\n    this.context.form.fieldsStore.addListener(FieldEvent.Added, this.reRender);\n    this.context.form.fieldsStore.addListener(FieldEvent.Removed, this.reRender);\n    this.context.form.addFieldDidValidateEventListener(this.reRender);\n    this.context.form.addFieldDidResetEventListener(this.reRender);\n  }\n\n  componentWillUnmount() {\n    this.context.form.fieldsStore.removeListener(FieldEvent.Added, this.reRender);\n    this.context.form.fieldsStore.removeListener(FieldEvent.Removed, this.reRender);\n    this.context.form.removeFieldDidValidateEventListener(this.reRender);\n    this.context.form.removeFieldDidResetEventListener(this.reRender);\n  }\n\n  reRender = () => {\n    this.forceUpdate();\n  };\n\n  render() {\n    let str = beautifulStringify(\n      normalizeFieldElementProperty(this.context.form.fieldsStore.fields),\n      2\n    );\n\n    // Cosmetic: improve formatting\n    //\n    // Replace this string:\n    // {\n    //   key: \"1.0\",\n    //   type: \"error\",\n    //   show: true\n    // }\n    // with this:\n    // { key: \"1.0\", type: \"error\", show: true }\n    str = str.replace(\n      /{\\s+key: (.*),\\s+type: (.*),\\s+show: (.*)\\s+}/g,\n      '{ key: $1, type: $2, show: $3 }'\n    );\n\n    return str;\n  }\n\n  /* eslint-enable react/destructuring-assignment */\n}\n\nexport { FormWithConstraints };\n\nexport class FieldFeedbacks extends _FieldFeedbacks {\n  render() {\n    const { for: fieldName, stop } = this.props;\n\n    let attr = '';\n    if (fieldName) attr += `for=\"${fieldName}\" `;\n    attr += `stop=\"${stop}\"`;\n\n    return (\n      <>\n        <li>\n          key=\"{this.key}\" {attr}\n        </li>\n        <ul>{super.render()}</ul>\n      </>\n    );\n  }\n}\n\nexport class FieldFeedback extends _FieldFeedback {\n  private rootEl: HTMLLIElement | null = null;\n\n  private getTextDecoration() {\n    const { show } = this.state.validation;\n\n    let textDecoration = '';\n    switch (show) {\n      case false:\n        textDecoration = 'line-through';\n        break;\n      case undefined:\n        textDecoration = 'line-through dotted';\n        break;\n      default:\n        textDecoration = '';\n    }\n\n    return textDecoration;\n  }\n\n  render() {\n    const { key, type } = this.state.validation;\n\n    return (\n      <li ref={rootEl => (this.rootEl = rootEl)}>\n        <span style={{ textDecoration: this.getTextDecoration() }}>\n          key=\"{key}\" type=\"{type}\"\n        </span>{' '}\n        {super.render()}\n      </li>\n    );\n  }\n\n  componentDidUpdate() {\n    // Hack: make FieldFeedback <span style=\"display: inline\">\n    // Also make Bootstrap 4 happy because it sets 'display: none', https://github.com/twbs/bootstrap/blob/v4.1.2/scss/mixins/_forms.scss#L31\n    const fieldFeedbackSpans = this.rootEl!.querySelectorAll<HTMLSpanElement>('[data-feedback]');\n    fieldFeedbackSpans.forEach(fieldFeedbackSpan => {\n      // eslint-disable-next-line no-param-reassign\n      fieldFeedbackSpan.style.display = 'inline';\n    });\n\n    // Change Async parent style\n    const li = this.rootEl!.closest('li.async');\n    if (li !== null) {\n      const async = li.querySelector<HTMLSpanElement>('span[style]');\n      async!.style.textDecoration = this.getTextDecoration();\n    }\n\n    // Change whenValid style\n    const { type } = this.state.validation;\n    if (type === FieldFeedbackType.WhenValid) {\n      const span = this.rootEl!.querySelector<HTMLSpanElement>('span[style]');\n      const whenValid = this.rootEl!.querySelector<HTMLSpanElement>(\n        `span.${this.props.classes!.valid}`\n      );\n      span!.style.textDecoration = whenValid !== null ? '' : 'line-through';\n    }\n  }\n}\n\nexport class Async<T> extends _Async<T> {\n  private rootEl: HTMLLIElement | null = null;\n\n  private static getTextDecoration() {\n    return 'line-through dotted';\n  }\n\n  componentDidUpdate() {\n    // Reset style\n    const async = this.rootEl!.querySelector<HTMLSpanElement>('span[style]');\n    async!.style.textDecoration = Async.getTextDecoration();\n  }\n\n  render() {\n    return (\n      <li className=\"async\" ref={rootEl => (this.rootEl = rootEl)}>\n        <span style={{ textDecoration: Async.getTextDecoration() }}>Async</span>\n        <ul>{super.render()}</ul>\n      </li>\n    );\n  }\n}\n"],"names":["isHTMLInput","FieldEvent","PropTypes.instanceOf","FormWithConstraints","React.Component","React.createElement","_FieldFeedbacks","FieldFeedbackType","_FieldFeedback","_Async"],"mappings":"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"}